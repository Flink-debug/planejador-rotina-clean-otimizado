<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#05060a" />
  <title>Rotina ‚Ä¢ Foco & Prosperidade</title>

  <!-- React 18 (PRODUCTION) -->
  <script crossorigin src="https://unpkg.com/react@18.3.1/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js"></script>

  <style>
    :root{
      --bg0:#05060a; --bg1:#061228;
      --panel:rgba(255,255,255,.06);
      --line:rgba(148,163,184,.20);
      --txt:#e5e7eb; --muted:#9aa3b2;

      --low:#22c55e;
      --med:#f59e0b;
      --high:#ef4444;

      --shadow: 0 18px 45px rgba(0,0,0,.42);
      --shadow2: 0 10px 26px rgba(0,0,0,.32);

      --r14:14px; --r18:18px; --r22:22px;

      /* Mood variables (evoluem com o ‚Äún√≠vel‚Äù) */
      --mGlow: .18;
      --mGlow2: .14;
      --mRich: .22;     /* opacidade do layer $$$ */
      --mSaturation: 1;
      --mLift: 0px;     /* micro lift de contraste */
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html, body{ height:100%; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial;
      color:var(--txt);
      min-height:100vh;
      overflow-x:hidden;
      color-scheme: dark;

      background:
        radial-gradient(1200px 650px at 15% 0%, rgba(59,130,246,var(--mGlow)), transparent 60%),
        radial-gradient(900px 700px at 85% 10%, rgba(56,189,248,var(--mGlow2)), transparent 55%),
        radial-gradient(900px 650px at 50% 100%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));

      filter: saturate(var(--mSaturation)) contrast(1.02);
      transform: translateZ(0);
    }

    /* $$$ background (notas) - sutil e evolutivo */
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      opacity: var(--mRich);
      background:
        radial-gradient(900px 520px at 15% 15%, rgba(0,0,0,.0), rgba(0,0,0,.50) 70%),
        radial-gradient(900px 520px at 85% 15%, rgba(0,0,0,.0), rgba(0,0,0,.50) 70%),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1600' height='900' viewBox='0 0 1600 900'%3E%3Cdefs%3E%3ClinearGradient id='bill' x1='0' x2='1'%3E%3Cstop offset='0' stop-color='%23a7f3d0' stop-opacity='.55'/%3E%3Cstop offset='1' stop-color='%236ee7b7' stop-opacity='.35'/%3E%3C/linearGradient%3E%3ClinearGradient id='shine' x1='0' x2='1'%3E%3Cstop offset='0' stop-color='%23ffffff' stop-opacity='.18'/%3E%3Cstop offset='1' stop-color='%23ffffff' stop-opacity='0'/%3E%3C/linearGradient%3E%3Cfilter id='s' x='-20%25' y='-20%25' width='140%25' height='140%25'%3E%3CfeDropShadow dx='0' dy='6' stdDeviation='6' flood-color='%23000000' flood-opacity='.28'/%3E%3C/filter%3E%3C/defs%3E%3Cg filter='url(%23s)'%3E%3Cg transform='translate(120 90) rotate(-12)'%3E%3Crect rx='14' ry='14' width='210' height='110' fill='url(%23bill)' fill-opacity='.22' stroke='%23a7f3d0' stroke-opacity='.20'/%3E%3Crect x='10' y='10' rx='12' ry='12' width='190' height='90' fill='none' stroke='%23e5e7eb' stroke-opacity='.14'/%3E%3Cpath d='M0 0 L210 0 L210 18 L0 50 Z' fill='url(%23shine)' opacity='.45'/%3E%3Ctext x='105' y='70' text-anchor='middle' font-family='Arial' font-size='44' fill='%23e5e7eb' fill-opacity='.18'%3E$%3C/text%3E%3C/g%3E%3Cg transform='translate(420 140) rotate(8)'%3E%3Crect rx='14' ry='14' width='210' height='110' fill='url(%23bill)' fill-opacity='.20' stroke='%23a7f3d0' stroke-opacity='.18'/%3E%3Crect x='10' y='10' rx='12' ry='12' width='190' height='90' fill='none' stroke='%23e5e7eb' stroke-opacity='.12'/%3E%3Cpath d='M0 0 L210 0 L210 16 L0 44 Z' fill='url(%23shine)' opacity='.40'/%3E%3Ctext x='105' y='70' text-anchor='middle' font-family='Arial' font-size='44' fill='%23e5e7eb' fill-opacity='.16'%3E$%3C/text%3E%3C/g%3E%3Cg transform='translate(740 80) rotate(-6)'%3E%3Crect rx='14' ry='14' width='210' height='110' fill='url(%23bill)' fill-opacity='.18' stroke='%23a7f3d0' stroke-opacity='.16'/%3E%3Crect x='10' y='10' rx='12' ry='12' width='190' height='90' fill='none' stroke='%23e5e7eb' stroke-opacity='.12'/%3E%3Cpath d='M0 0 L210 0 L210 18 L0 48 Z' fill='url(%23shine)' opacity='.38'/%3E%3Ctext x='105' y='70' text-anchor='middle' font-family='Arial' font-size='44' fill='%23e5e7eb' fill-opacity='.14'%3E$%3C/text%3E%3C/g%3E%3Cg transform='translate(1040 150) rotate(10)'%3E%3Crect rx='14' ry='14' width='210' height='110' fill='url(%23bill)' fill-opacity='.18' stroke='%23a7f3d0' stroke-opacity='.16'/%3E%3Crect x='10' y='10' rx='12' ry='12' width='190' height='90' fill='none' stroke='%23e5e7eb' stroke-opacity='.12'/%3E%3Cpath d='M0 0 L210 0 L210 18 L0 46 Z' fill='url(%23shine)' opacity='.36'/%3E%3Ctext x='105' y='70' text-anchor='middle' font-family='Arial' font-size='44' fill='%23e5e7eb' fill-opacity='.14'%3E$%3C/text%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-size: cover;
      transform: translateZ(0);
      transition: opacity .6s ease;
    }

    body::after{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background: linear-gradient(180deg, rgba(0,0,0,.26), rgba(0,0,0,.74));
    }

    /* ‚ÄúLevel up‚Äù animation */
    body.levelUp{
      animation: levelUpPulse 1.2s ease;
    }
    @keyframes levelUpPulse{
      0%{ filter:saturate(var(--mSaturation)) contrast(1.02); }
      35%{ filter:saturate(calc(var(--mSaturation) + .10)) contrast(1.08); }
      100%{ filter:saturate(var(--mSaturation)) contrast(1.02); }
    }

    .app{ position:relative; z-index:1; }
    .container{ max-width:1200px; margin:0 auto; padding:22px; }

    .top{ display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap; }
    .title{ font-size:28px; font-weight:900; letter-spacing:.2px; }

    .glass{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--r22);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .card{
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      border-radius: var(--r22);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .row{ display:flex; gap:14px; flex-wrap:wrap; }
    .col{ flex:1 1 320px; min-width:280px; }

    .muted{ color:var(--muted); }
    .kicker{ font-size:12px; letter-spacing:.2px; font-weight:900; color:#cbd5e1; }
    .big{ font-size:30px; font-weight:950; margin-top:6px; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      font-weight:900;
      font-size:12px;
      color:#e2e8f0;
      white-space:nowrap;
    }

    .btn{
      border:1px solid transparent;
      border-radius: var(--r14);
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      transition: transform .08s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease, opacity .18s ease;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      min-height:44px;
      position:relative;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .btnPrimary{
      background: linear-gradient(180deg, rgba(59,130,246,.92), rgba(37,99,235,.92));
      box-shadow: 0 12px 26px rgba(37,99,235,.22);
      color:#fff;
    }
    .btnSoft{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.14);
      color: var(--txt);
      border:1px solid rgba(255,255,255,.14);
    }
    .btnSoft:hover{ background: rgba(255,255,255,.12); }

    .input{
      width:100%;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      border-radius: var(--r14);
      padding:12px 12px;
      outline:none;
      color:var(--txt);
      transition: border-color .18s ease, box-shadow .18s ease;
    }
    .input:focus{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 4px rgba(59,130,246,.16);
    }
    textarea{ resize:none; }

    .grid2{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
    .grid3{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; }
    @media (max-width:760px){ .grid3{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

    .label{
      display:flex; gap:8px; align-items:center;
      font-size:12px;
      font-weight:950;
      color:#cbd5e1;
      margin-bottom:8px;
      letter-spacing:.2px;
    }

    .chip{
      display:flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 12px;
      border-radius: var(--r14);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-weight:950;
      transition: transform .08s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
      min-height:44px;
      position:relative;
      overflow:hidden;
    }
    .chip:hover{ background: rgba(255,255,255,.10); }
    .chip:active{ transform: translateY(1px) scale(.99); }
    .chipOn{
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.28);
      box-shadow: 0 12px 28px rgba(0,0,0,.22);
    }

    .tLow{ border-color: rgba(34,197,94,.42) !important; box-shadow: 0 0 0 4px rgba(34,197,94,.12) !important; }
    .tMed{ border-color: rgba(245,158,11,.45) !important; box-shadow: 0 0 0 4px rgba(245,158,11,.12) !important; }
    .tHigh{ border-color: rgba(239,68,68,.45) !important; box-shadow: 0 0 0 4px rgba(239,68,68,.12) !important; }

    .barWrap{ margin-top:10px; background: rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.12); border-radius:999px; overflow:hidden; height:12px; }
    .barFill{ height:100%; width:0%; border-radius:999px; transition: width .6s cubic-bezier(.2,.8,.2,1); }

    .listHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px;
      background: rgba(255,255,255,.04);
      border-bottom:1px solid rgba(255,255,255,.10);
      gap:12px;
      flex-wrap:wrap;
    }
    .listBody{ padding:18px; display:flex; flex-direction:column; gap:12px; }

    .act{
      border-radius: var(--r18);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      transition: transform .10s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease, opacity .18s ease;
      animation: slideUp .20s ease;
    }
    .act:hover{ box-shadow: 0 16px 34px rgba(0,0,0,.24); }
    .actTop{
      padding:14px 14px;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    }
    .actLeft{ display:flex; gap:12px; align-items:flex-start; }
    .check{
      width:22px; height:22px; margin-top:2px;
      accent-color: #60a5fa;
      cursor:pointer;
    }
    .actTitle{ font-weight:950; font-size:18px; line-height:1.15; }
    .actMeta{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:950;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#e2e8f0;
    }
    .actDesc{ margin-top:8px; color:#cbd5e1; line-height:1.35; }

    .actBtns{ display:flex; gap:10px; }
    .miniBtn{
      padding:10px 12px;
      border-radius: var(--r14);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#e5e7eb;
      font-weight:950;
      cursor:pointer;
      transition: transform .08s ease, background .18s ease, border-color .18s ease;
      display:flex; align-items:center; gap:8px;
      min-height:40px;
      white-space:nowrap;
    }
    .miniBtn:hover{ background: rgba(255,255,255,.10); }
    .miniBtn:active{ transform: translateY(1px) scale(.99); }
    .miniDanger{
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.28);
      color:#fecaca;
    }
    .miniDanger:hover{ background: rgba(239,68,68,.20); }

    .pLow { border-color: rgba(34,197,94,.40); background: linear-gradient(180deg, rgba(34,197,94,.10), rgba(255,255,255,.04)); }
    .pMed { border-color: rgba(245,158,11,.44); background: linear-gradient(180deg, rgba(245,158,11,.12), rgba(255,255,255,.04)); }
    .pHigh{ border-color: rgba(239,68,68,.44); background: linear-gradient(180deg, rgba(239,68,68,.12), rgba(255,255,255,.04)); }

    .done{ opacity:.78; filter:saturate(.9); }

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:flex; align-items:center; justify-content:center;
      padding:18px;
      z-index:40;
      animation: fadeIn .18s ease;
    }
    .modal{
      width:min(980px, 100%);
      border-radius:22px;
      background: rgba(10,14,24,.92);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      overflow:hidden;
      animation: popIn .18s ease;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 18px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .modalTitle{ display:flex; align-items:center; gap:10px; font-size:22px; font-weight:950; }
    .modalBody{ padding:18px; }

    /* Toast */
    .toasts{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 60;
      display:flex;
      flex-direction:column;
      gap:10px;
      width: min(380px, calc(100vw - 32px));
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(10,14,24,.94);
      box-shadow: var(--shadow2);
      display:flex;
      gap:10px;
      align-items:flex-start;
      animation: slideInRight .22s ease;
    }
    .toastTitle{ font-weight:950; }
    .toastMsg{ color:#cbd5e1; margin-top:4px; font-size:13px; line-height:1.3; }
    .toastX{
      margin-left:auto;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      color:#e5e7eb;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:950;
      transition: background .18s ease;
    }
    .toastX:hover{ background: rgba(255,255,255,.12); }

    /* Calend√°rio mensal */
    .calWrap{ margin-top:12px; }
    .calHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
    }
    .calGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap:10px;
    }
    .calDow{
      text-align:center;
      font-weight:950;
      font-size:12px;
      color:#cbd5e1;
      padding:8px 0;
      border-radius:12px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
    }
    .calCell{
      min-height:78px;
      padding:10px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      transition: transform .08s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
      position:relative;
      overflow:hidden;
    }
    .calCell:hover{ background: rgba(255,255,255,.08); }
    .calCell:active{ transform: translateY(1px) scale(.99); }
    .calMuted{
      opacity:.45;
      cursor:default;
    }
    .calSelected{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 4px rgba(59,130,246,.14);
      background: rgba(59,130,246,.10);
    }
    .calToday{
      border-color: rgba(34,197,94,.40);
      box-shadow: 0 0 0 4px rgba(34,197,94,.10);
    }
    .calDayNum{
      font-weight:950;
      font-size:14px;
      color:#e5e7eb;
    }
    .calMini{
      margin-top:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color:#cbd5e1;
      font-size:12px;
      font-weight:950;
    }
    .calDots{
      display:flex; gap:6px; align-items:center;
    }
    .dot{
      width:8px; height:8px;
      border-radius:999px;
      opacity:.95;
    }

    /* Reset modal tabs */
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; }
    .tabBtn{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#e5e7eb;
      font-weight:950;
      cursor:pointer;
      transition: background .18s ease, border-color .18s ease, transform .08s ease;
    }
    .tabBtn:hover{ background: rgba(255,255,255,.10); }
    .tabBtn:active{ transform: translateY(1px) scale(.99); }
    .tabOn{
      background: rgba(59,130,246,.18);
      border-color: rgba(59,130,246,.40);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
    }

    /* Tooltips (sem depender de libs) */
    [data-tip]{ position:relative; }
    [data-tip]:hover::after,
    [data-tip]:focus-visible::after{
      content: attr(data-tip);
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      bottom: calc(100% + 10px);
      z-index: 80;
      white-space: normal;
      width: min(280px, 70vw);
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(10,14,24,.96);
      box-shadow: var(--shadow2);
      color:#e5e7eb;
      font-size:12px;
      font-weight:900;
      line-height:1.25;
    }
    [data-tip]:hover::before,
    [data-tip]:focus-visible::before{
      content:"";
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      bottom: calc(100% + 2px);
      width: 10px; height: 10px;
      background: rgba(10,14,24,.96);
      border-left:1px solid rgba(255,255,255,.16);
      border-top:1px solid rgba(255,255,255,.16);
      transform: translateX(-50%) rotate(225deg);
      border-radius: 2px;
      z-index: 79;
    }

    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    @keyframes popIn{ from{opacity:0; transform: translateY(8px) scale(.98)} to{opacity:1; transform:none} }
    @keyframes slideUp{ from{opacity:0; transform: translateY(10px)} to{opacity:1; transform:none} }
    @keyframes slideInRight{ from{opacity:0; transform: translateX(12px)} to{opacity:1; transform:none} }

    .sp10{ height:10px; } .sp16{ height:16px; } .sp20{ height:20px; }

    @media (max-width:760px){
      .container{ padding:18px; }
      .title{ font-size:24px; }
      .big{ font-size:28px; }
      .actTop{ flex-direction:column; }
      .actBtns{ width:100%; }
      .miniBtn{ flex:1; justify-content:center; }
      .calCell{ min-height:70px; }
      /* tooltip por hover n√£o existe no mobile; fica ok mesmo assim */
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script>
    const e = React.createElement;
    const { useEffect, useMemo, useRef, useState } = React;

    // ===== Helpers =====
    const uid = () => Date.now() + Math.floor(Math.random() * 1000);
    const clampInt = (v, fallback=0) => {
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : fallback;
    };
    const pad2 = (n) => String(n).padStart(2,'0');
    const todayISO = () => new Date().toISOString().split("T")[0];

    const parseTimeToMinutes = (hhmm) => {
      if (!hhmm || typeof hhmm !== "string" || !hhmm.includes(":")) return null;
      const [h,m] = hhmm.split(":").map(x => clampInt(x,0));
      if (h < 0 || h > 23 || m < 0 || m > 59) return null;
      return h*60 + m;
    };

    const formatDateBR = (iso) => {
      const [y,m,d] = iso.split("-").map(x => clampInt(x,0));
      if (!y || !m || !d) return iso;
      return `${pad2(d)}/${pad2(m)}/${y}`;
    };

    const addDaysISO = (iso, delta) => {
      const dt = new Date(iso + "T00:00:00");
      dt.setDate(dt.getDate() + delta);
      return dt.toISOString().split("T")[0];
    };

    const monthKeyOfISO = (iso) => iso.slice(0,7); // YYYY-MM
    const getCurrentMonthKey = () => {
      const now = new Date();
      return `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
    };

    const monthLabelBR = (yyyyMm) => {
      const [y,m] = yyyyMm.split("-").map(x => clampInt(x,0));
      const names = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
      return `${names[(m||1)-1]} ${y}`;
    };

    const daysInMonth = (yyyy, mm1) => new Date(yyyy, mm1, 0).getDate(); // mm1: 1..12
    const isoOf = (yyyy, mm1, dd) => `${yyyy}-${pad2(mm1)}-${pad2(dd)}`;

    // Monday-first DOW: SEG..DOM
    const mondayFirstIndex = (jsDow) => (jsDow === 0 ? 6 : jsDow - 1); // 0..6 where 0=SEG
    const buildMonthGrid = (yyyyMm) => {
      const [yyyy, mm1] = yyyyMm.split("-").map(x => clampInt(x,0));
      const first = new Date(isoOf(yyyy, mm1, 1) + "T00:00:00");
      const firstIdx = mondayFirstIndex(first.getDay()); // 0..6
      const dim = daysInMonth(yyyy, mm1);

      const cells = [];
      // Previous month for leading days
      const prevMm1 = mm1 === 1 ? 12 : mm1 - 1;
      const prevY = mm1 === 1 ? yyyy - 1 : yyyy;
      const prevDim = daysInMonth(prevY, prevMm1);

      for (let i=0; i<firstIdx; i++){
        const dd = prevDim - (firstIdx - 1 - i);
        cells.push({ iso: isoOf(prevY, prevMm1, dd), inMonth:false });
      }
      // current month
      for (let dd=1; dd<=dim; dd++){
        cells.push({ iso: isoOf(yyyy, mm1, dd), inMonth:true });
      }
      // next month trailing
      const nextMm1 = mm1 === 12 ? 1 : mm1 + 1;
      const nextY = mm1 === 12 ? yyyy + 1 : yyyy;
      while (cells.length < 42){
        const dd = cells.length - (firstIdx + dim) + 1;
        cells.push({ iso: isoOf(nextY, nextMm1, dd), inMonth:false });
      }
      return cells;
    };

    const categoryConfig = {
      TRABALHO:     { emoji:"üíº" },
      ESTUDOS:      { emoji:"üìö" },
      EXERCICIOS:   { emoji:"üèãÔ∏è" },
      PESSOAL:      { emoji:"üß†" },
      SAUDE:        { emoji:"‚ù§Ô∏è" },
      ALIMENTACAO:  { emoji:"ü•ó" },
      OUTROS:       { emoji:"üß©" },
    };

    const priorityConfig = {
      low:  { emoji:"üü¢", label:"Baixa",  card:"pLow",  tint:"tLow",  weight:1 },
      med:  { emoji:"üü°", label:"M√©dia",  card:"pMed",  tint:"tMed",  weight:2 },
      high: { emoji:"üî¥", label:"Alta",   card:"pHigh", tint:"tHigh", weight:3 },
    };

    const safeJSON = (value, fallback) => {
      try { return value ? JSON.parse(value) : fallback; } catch { return fallback; }
    };

    const weekday = (iso) => {
      const dt = new Date(iso + "T00:00:00");
      const names = ["DOM","SEG","TER","QUA","QUI","SEX","S√ÅB"];
      return names[dt.getDay()];
    };

    const isISOInSameMonth = (iso, monthKey) => monthKeyOfISO(iso) === monthKey;

    // Semanas do m√™s = fases
    function weekPhaseOfMonth(iso){
      const d = clampInt(iso.slice(8,10), 1);
      if (d <= 7) return 1;
      if (d <= 14) return 2;
      if (d <= 21) return 3;
      if (d <= 28) return 4;
      return 5;
    }

    function phaseRange(monthKey, phase){
      const [y,m] = monthKey.split("-").map(x => clampInt(x,0));
      const dim = daysInMonth(y, m);
      const startDay = (phase===1)?1:(phase===2)?8:(phase===3)?15:(phase===4)?22:29;
      const endDay = (phase===1)?7:(phase===2)?14:(phase===3)?21:(phase===4)?28:dim;
      return { startISO: isoOf(y,m,startDay), endISO: isoOf(y,m,endDay) };
    }

    function inRangeISO(iso, start, end){ return iso >= start && iso <= end; }

    function Modal({ open, onClose, title, children }){
      if (!open) return null;
      return e("div", { className:"overlay", onMouseDown:(ev)=>{ if (ev.target === ev.currentTarget) onClose(); } },
        e("div", { className:"modal", role:"dialog", "aria-modal":"true" },
          e("div", { className:"modalHead" },
            e("div", { className:"modalTitle" }, title),
            e("button", { className:"btn btnSoft", style:{ padding:"10px 12px" }, onClick:onClose, "data-tip":"Fechar janela." }, "‚úï")
          ),
          e("div", { className:"modalBody" }, children)
        )
      );
    }

    function DailyRoutine(){
      const LS = {
        byDate:"activitiesByDate",
        notif:"notifEnabled",
        sound:"soundEnabled",

        // Reset mensal / jogo
        lastMonthSeen:"lastMonthSeen",
        monthState:"monthGameState", // { monthKey, levelUnlocked, phasesUnlocked: {1:true..}, archived:{} }
        monthArchive:"monthArchive", // hist√≥rico dos meses
      };

      const [activitiesByDate, setActivitiesByDate] = useState({});
      const [selectedDate, setSelectedDate] = useState(todayISO());
      const [plannerMode, setPlannerMode] = useState("day"); // "day" | "month"
      const [monthView, setMonthView] = useState(getCurrentMonthKey()); // YYYY-MM

      const [notifEnabled, setNotifEnabled] = useState(false);
      const [soundEnabled, setSoundEnabled] = useState(true);

      const [modalOpen, setModalOpen] = useState(false);
      const [editing, setEditing] = useState(null);

      const [exportOpen, setExportOpen] = useState(false);
      const [exportData, setExportData] = useState("");
      const [importData, setImportData] = useState("");

      const [resetOpen, setResetOpen] = useState(false);
      const [resetTab, setResetTab] = useState("atividade"); // atividade | dia | intervalo

      const [toasts, setToasts] = useState([]);

      const timersRef = useRef([]);
      const heartbeatRef = useRef(null);

      // Audio POP
      const audioCtxRef = useRef(null);
      const audioUnlockedRef = useRef(false);

      const showToast = (title, msg, ttl=6500) => {
        const id = uid();
        setToasts(prev => [{ id, title, msg }, ...prev].slice(0,4));
        if (ttl > 0) setTimeout(() => removeToast(id), ttl);
      };
      const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));

      const unlockAudio = () => {
        if (audioUnlockedRef.current) return;
        try{
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (!Ctx) return;
          audioCtxRef.current = audioCtxRef.current || new Ctx();
          const ctx = audioCtxRef.current;
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          g.gain.value = 0.0001;
          o.connect(g); g.connect(ctx.destination);
          o.start();
          o.stop(ctx.currentTime + 0.01);
          audioUnlockedRef.current = true;
        }catch{}
      };

      useEffect(() => {
        const handler = () => unlockAudio();
        window.addEventListener("pointerdown", handler, { once:true });
        window.addEventListener("keydown", handler, { once:true });
        return () => {
          window.removeEventListener("pointerdown", handler);
          window.removeEventListener("keydown", handler);
        };
      }, []);

      const playPop = () => {
        if (!soundEnabled) return;
        try{
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (!Ctx) return;
          const ctx = audioCtxRef.current || new Ctx();
          audioCtxRef.current = ctx;

          const now = ctx.currentTime;
          const o = ctx.createOscillator();
          const g = ctx.createGain();

          o.type = "sine";
          o.frequency.setValueAtTime(520, now);
          o.frequency.exponentialRampToValueAtTime(860, now + 0.06);

          g.gain.setValueAtTime(0.0001, now);
          g.gain.exponentialRampToValueAtTime(0.18, now + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, now + 0.16);

          o.connect(g);
          g.connect(ctx.destination);

          o.start(now);
          o.stop(now + 0.18);
        }catch{}
      };

      const testSound = () => {
        unlockAudio();
        playPop();
        showToast("üîä Som", "Teste de som executado.");
      };

      // ===== Normaliza√ß√£o / Migra√ß√£o =====
      const normalizeActivity = (a, dateISO) => {
        const priority = a.priority || a.priorityLevel || "med";
        const cat = (a.category || a.cat || "PESSOAL").toUpperCase();
        const startTime = a.startTime || a.time || "09:00";
        const endTime = a.endTime || a.time || "10:00";

        return {
          id: a.id ?? uid(),
          date: a.date || dateISO,
          title: (a.title ?? "").trim(),
          startTime,
          endTime,
          category: categoryConfig[cat] ? cat : "OUTROS",
          description: a.description || "",
          priority: priorityConfig[priority] ? priority : "med",
          completed: !!a.completed,
          remind: a.remind !== false
        };
      };

      // ===== Game State (mensal) =====
      function getDefaultMonthState(monthKey){
        return {
          monthKey,
          levelUnlocked: 0, // 0..5
          phasesUnlocked: { 1:false, 2:false, 3:false, 4:false, 5:false },
          lastLevelUpAt: null
        };
      }

      const [monthState, setMonthState] = useState(getDefaultMonthState(getCurrentMonthKey()));
      const [monthArchive, setMonthArchive] = useState({}); // { "2026-01": {...} }

      // ===== Load =====
      useEffect(() => {
        let loadedByDate = safeJSON(localStorage.getItem(LS.byDate), null);

        // migra√ß√£o legado (array no dailyRoutineData)
        if (!loadedByDate){
          const legacy = safeJSON(localStorage.getItem("dailyRoutineData"), null);
          if (Array.isArray(legacy)){
            const td = todayISO();
            loadedByDate = { [td]: legacy.map(a => normalizeActivity(a, td)) };
            localStorage.setItem(LS.byDate, JSON.stringify(loadedByDate));
          } else {
            loadedByDate = {};
          }
        } else {
          const fixed = {};
          Object.keys(loadedByDate || {}).forEach(dateISO => {
            const arr = Array.isArray(loadedByDate[dateISO]) ? loadedByDate[dateISO] : [];
            fixed[dateISO] = arr.map(a => normalizeActivity(a, dateISO));
          });
          loadedByDate = fixed;
        }

        const notifRaw = localStorage.getItem(LS.notif);
        const loadedNotif = notifRaw === "true";

        const soundRaw = localStorage.getItem(LS.sound);
        const loadedSound = soundRaw === null ? true : (soundRaw === "true");

        const ms = safeJSON(localStorage.getItem(LS.monthState), null);
        const arch = safeJSON(localStorage.getItem(LS.monthArchive), {});

        setActivitiesByDate(loadedByDate || {});
        setNotifEnabled(loadedNotif);
        setSoundEnabled(loadedSound);

        setMonthArchive(arch || {});

        const nowMonth = getCurrentMonthKey();
        const initialState = (ms && ms.monthKey === nowMonth) ? ms : getDefaultMonthState(nowMonth);
        setMonthState(initialState);

        setMonthView(monthKeyOfISO(todayISO()));
        setSelectedDate(todayISO());

        // Reset mensal autom√°tico (dia 1 / mudan√ßa de m√™s)
        const lastMonthSeen = localStorage.getItem(LS.lastMonthSeen);
        const today = todayISO();
        const todayDay = clampInt(today.slice(8,10), 1);
        const curMonth = monthKeyOfISO(today);

        if (lastMonthSeen !== curMonth){
          // mudou m√™s (ou primeira abertura)
          localStorage.setItem(LS.lastMonthSeen, curMonth);

          // Se n√£o √© a primeira vez e realmente virou m√™s, arquiva m√™s anterior e reseta estado
          if (lastMonthSeen){
            // arquivar estado anterior
            const prevMonth = lastMonthSeen;
            const prevState = ms && ms.monthKey === prevMonth ? ms : null;

            const archiveCopy = { ...(arch||{}) };
            archiveCopy[prevMonth] = {
              archivedAt: today,
              monthKey: prevMonth,
              monthState: prevState,
              // opcional: snapshot das atividades daquele m√™s (somente do m√™s anterior)
              activitiesByDate: Object.fromEntries(
                Object.entries(loadedByDate || {}).filter(([d,_]) => monthKeyOfISO(d) === prevMonth)
              )
            };
            setMonthArchive(archiveCopy);
            localStorage.setItem(LS.monthArchive, JSON.stringify(archiveCopy));
          }

          // reset ‚Äújogo‚Äù do m√™s atual
          const fresh = getDefaultMonthState(curMonth);
          setMonthState(fresh);
          localStorage.setItem(LS.monthState, JSON.stringify(fresh));

          // regra: reset todo dia 1 ‚Äî mas aqui √© melhor: reset ao virar o m√™s
          if (todayDay === 1){
            showToast("üóìÔ∏è Novo m√™s", "Progresso resetado. Bora subir de n√≠vel.");
          }
        }
      }, []);

      // Persist
      useEffect(() => localStorage.setItem(LS.byDate, JSON.stringify(activitiesByDate)), [activitiesByDate]);
      useEffect(() => localStorage.setItem(LS.notif, String(notifEnabled)), [notifEnabled]);
      useEffect(() => localStorage.setItem(LS.sound, String(soundEnabled)), [soundEnabled]);
      useEffect(() => localStorage.setItem(LS.monthState, JSON.stringify(monthState)), [monthState]);
      useEffect(() => localStorage.setItem(LS.monthArchive, JSON.stringify(monthArchive)), [monthArchive]);

      // ===== Mood (background evolutivo) =====
      const moodFromLevel = (level) => {
        // clean: altera somente intensidades, sem virar carnaval
        const table = [
          { mGlow:.16, mGlow2:.12, mRich:.18, mSat:1.00 },
          { mGlow:.18, mGlow2:.14, mRich:.22, mSat:1.02 },
          { mGlow:.21, mGlow2:.16, mRich:.26, mSat:1.04 },
          { mGlow:.24, mGlow2:.18, mRich:.30, mSat:1.06 },
          { mGlow:.28, mGlow2:.20, mRich:.34, mSat:1.08 },
          { mGlow:.32, mGlow2:.23, mRich:.38, mSat:1.10 },
        ];
        return table[Math.max(0, Math.min(5, level))];
      };

      useEffect(() => {
        const s = moodFromLevel(monthState.levelUnlocked || 0);
        document.documentElement.style.setProperty("--mGlow", String(s.mGlow));
        document.documentElement.style.setProperty("--mGlow2", String(s.mGlow2));
        document.documentElement.style.setProperty("--mRich", String(s.mRich));
        document.documentElement.style.setProperty("--mSaturation", String(s.mSat));
      }, [monthState.levelUnlocked]);

      const triggerLevelUpAnim = () => {
        document.body.classList.remove("levelUp");
        void document.body.offsetWidth;
        document.body.classList.add("levelUp");
        setTimeout(()=>document.body.classList.remove("levelUp"), 1300);
      };

      // ===== Derivados do dia selecionado =====
      const dayActivities = useMemo(() => activitiesByDate[selectedDate] || [], [activitiesByDate, selectedDate]);

      const sorted = useMemo(() => {
        const copy = [...dayActivities];
        copy.sort((a,b) => {
          const am = parseTimeToMinutes(a.startTime) ?? 0;
          const bm = parseTimeToMinutes(b.startTime) ?? 0;
          if (am !== bm) return am - bm;
          return (a.title || "").localeCompare(b.title || "");
        });
        return copy;
      }, [dayActivities]);

      // ===== Stats do m√™s (score ponderado por prioridade) =====
      function monthScoreStats(monthKey){
        let possible = 0;
        let done = 0;

        Object.entries(activitiesByDate || {}).forEach(([d, arr]) => {
          if (monthKeyOfISO(d) !== monthKey) return;
          (arr||[]).forEach(a => {
            const w = (priorityConfig[a.priority] || priorityConfig.med).weight;
            possible += w;
            if (a.completed) done += w;
          });
        });

        const pct = possible > 0 ? Math.round((done/possible)*100) : 0;
        return { possible, done, pct };
      }

      // ===== Stats da ‚Äúfase‚Äù atual (semana do m√™s) =====
      function phaseStats(monthKey, phase){
        const { startISO, endISO } = phaseRange(monthKey, phase);
        let total = 0, completed = 0;
        let possible = 0, done = 0;

        Object.entries(activitiesByDate || {}).forEach(([d, arr]) => {
          if (monthKeyOfISO(d) !== monthKey) return;
          if (!inRangeISO(d, startISO, endISO)) return;

          const list = arr || [];
          total += list.length;
          completed += list.filter(x => x.completed).length;

          list.forEach(a => {
            const w = (priorityConfig[a.priority] || priorityConfig.med).weight;
            possible += w;
            if (a.completed) done += w;
          });
        });

        const pct = possible > 0 ? Math.round((done/possible)*100) : (total>0 ? Math.round((completed/total)*100) : 0);
        return { startISO, endISO, total, completed, possible, done, pct };
      }

      const currentMonthKey = useMemo(() => getCurrentMonthKey(), []);
      const currentPhase = useMemo(() => weekPhaseOfMonth(todayISO()), []);
      const curPhaseStats = useMemo(() => phaseStats(currentMonthKey, currentPhase), [activitiesByDate, currentMonthKey, currentPhase]);
      const curMonthStats = useMemo(() => monthScoreStats(currentMonthKey), [activitiesByDate, currentMonthKey]);

      // ===== Unlock de fase/n√≠vel (meta 70%) =====
      const PHASE_GOAL = 70;

      useEffect(() => {
        // S√≥ avalia unlock no m√™s atual (jogo do m√™s corrente)
        const nowMonth = getCurrentMonthKey();
        if (monthState.monthKey !== nowMonth) return;

        // tenta unlock das fases j√° ‚Äúpassadas ou atual‚Äù conforme desempenho
        const nextState = { ...monthState, phasesUnlocked: { ...monthState.phasesUnlocked } };
        let changed = false;

        for (let p=1; p<=5; p++){
          const st = phaseStats(nowMonth, p);
          if (st.total === 0 && st.possible === 0) continue; // n√£o for√ßa unlock sem conte√∫do
          if (st.pct >= PHASE_GOAL && !nextState.phasesUnlocked[p]){
            nextState.phasesUnlocked[p] = true;
            changed = true;
          }
        }

        // n√≠vel = quantas fases destravadas (0..5)
        const unlockedCount = Object.values(nextState.phasesUnlocked).filter(Boolean).length;
        if (unlockedCount !== (monthState.levelUnlocked||0)){
          nextState.levelUnlocked = unlockedCount;
          nextState.lastLevelUpAt = todayISO();
          changed = true;
          showToast("üíé Level UP", `N√≠vel ${unlockedCount}/5 desbloqueado.`);
          triggerLevelUpAnim();
        }

        if (changed) setMonthState(nextState);
      }, [activitiesByDate]);

      // ===== ‚ÄúDia conclu√≠do‚Äù anima√ß√£o + toast =====
      const prevAllDoneRef = useRef(false);
      useEffect(() => {
        const allDone = dayActivities.length > 0 && dayActivities.every(a => a.completed);
        if (allDone && !prevAllDoneRef.current){
          showToast("‚úÖ Dia conclu√≠do", "Todas as atividades do dia foram finalizadas.");
          triggerLevelUpAnim();
        }
        prevAllDoneRef.current = allDone;
      }, [dayActivities]);

      // ===== Calend√°rio: resumo di√°rio =====
      const daySummary = (iso) => {
        const arr = activitiesByDate[iso] || [];
        const total = arr.length;
        const completed = arr.filter(a => a.completed).length;
        const p = { low:0, med:0, high:0 };
        arr.forEach(a => { if (p[a.priority] !== undefined) p[a.priority]++; });
        return { total, completed, p };
      };

      const monthCells = useMemo(() => buildMonthGrid(monthView), [monthView]);

      const goMonth = (delta) => {
        const [y,m] = monthView.split("-").map(x => clampInt(x,0));
        const dt = new Date(`${y}-${pad2(m)}-01T00:00:00`);
        dt.setMonth(dt.getMonth() + delta);
        const nk = `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}`;
        setMonthView(nk);
      };

      // ===== CRUD =====
      const openNew = () => { setEditing(null); setModalOpen(true); };
      const openEdit = (a) => { setEditing(a); setModalOpen(true); };

      const upsertActivity = (activity) => {
        const dateISO = activity.date || selectedDate;
        setActivitiesByDate(prev => {
          const copy = { ...prev };
          const arr = Array.isArray(copy[dateISO]) ? [...copy[dateISO]] : [];
          const idx = arr.findIndex(x => x.id === activity.id);
          if (idx >= 0) arr[idx] = activity;
          else arr.push(activity);
          copy[dateISO] = arr;
          return copy;
        });
      };

      const removeActivity = (dateISO, id) => {
        setActivitiesByDate(prev => {
          const copy = { ...prev };
          const arr = Array.isArray(copy[dateISO]) ? copy[dateISO] : [];
          copy[dateISO] = arr.filter(a => a.id !== id);
          if (copy[dateISO].length === 0) delete copy[dateISO];
          return copy;
        });
      };

      const saveActivity = (payload) => {
        const dateISO = editing?.date || selectedDate;
        if (editing){
          upsertActivity({ ...editing, ...payload, date: dateISO, id: editing.id, completed: editing.completed });
          showToast("‚úèÔ∏è Atualizado", "Atividade alterada.");
        } else {
          upsertActivity({ ...payload, date: dateISO, id: uid(), completed:false });
          showToast("‚ûï Criado", "Atividade adicionada.");
        }
        setModalOpen(false);
        setEditing(null);
      };

      const toggleDone = (dateISO, id) => {
        setActivitiesByDate(prev => {
          const copy = { ...prev };
          const arr = Array.isArray(copy[dateISO]) ? [...copy[dateISO]] : [];
          copy[dateISO] = arr.map(a => a.id === id ? { ...a, completed: !a.completed } : a);
          return copy;
        });
      };

      const deleteActivity = (dateISO, id) => {
        if (!confirm("Tem certeza que deseja deletar?")) return;
        removeActivity(dateISO, id);
        showToast("üóëÔ∏è Removido", "Atividade deletada.");
      };

      // ===== Export / Import =====
      const exportRoutine = () => {
        const data = {
          activitiesByDate,
          notifEnabled,
          soundEnabled,
          monthState,
          monthArchive
        };
        const txt = JSON.stringify(data, null, 2);
        setExportData(txt);
        setExportOpen(true);
        showToast("üì¶ Exportado", "JSON gerado.");
      };

      const importRoutine = () => {
        try{
          const data = JSON.parse(importData);
          const byDate = data.activitiesByDate || {};
          const fixed = {};
          Object.keys(byDate).forEach(d => {
            const arr = Array.isArray(byDate[d]) ? byDate[d] : [];
            fixed[d] = arr.map(a => normalizeActivity(a, d));
          });

          setActivitiesByDate(fixed);
          if (data.notifEnabled !== undefined) setNotifEnabled(!!data.notifEnabled);
          if (data.soundEnabled !== undefined) setSoundEnabled(!!data.soundEnabled);

          if (data.monthArchive) setMonthArchive(data.monthArchive);
          if (data.monthState && data.monthState.monthKey === getCurrentMonthKey()){
            setMonthState(data.monthState);
          }

          setImportData("");
          setExportOpen(false);
          showToast("‚úÖ Importado", "Dados restaurados.");
        }catch{
          showToast("‚ùå Erro", "JSON inv√°lido.");
        }
      };

      const copyToClipboard = async () => {
        try{
          if (navigator.clipboard && window.isSecureContext){
            await navigator.clipboard.writeText(exportData || "");
            showToast("üìã Copiado", "JSON copiado.");
            return;
          }
        }catch{}
        try{
          const ta = document.createElement("textarea");
          ta.value = exportData || "";
          ta.setAttribute("readonly", "");
          ta.style.position = "fixed";
          ta.style.top = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          showToast("üìã Copiado", "JSON copiado.");
        }catch{
          showToast("‚ö†Ô∏è Copiar", "Copie manualmente.");
        }
      };

      // ===== Notifications / Reminders =====
      const requestNotificationPermission = async () => {
        if (!("Notification" in window)){
          showToast("‚ö†Ô∏è Notifica√ß√µes", "Navegador n√£o suporta notifica√ß√µes.");
          return;
        }
        try{
          const p = await Notification.requestPermission();
          if (p === "granted"){
            setNotifEnabled(true);
            showToast("üîî Notifica√ß√µes", "Ativadas.");
          } else {
            setNotifEnabled(false);
            showToast("üîï Notifica√ß√µes", "Bloqueadas.");
          }
        }catch{
          showToast("‚ö†Ô∏è Notifica√ß√µes", "Falha ao solicitar permiss√£o.");
        }
      };

      const remindedKey = "remindedTodayMap_v2";
      const getRemindedMap = () => {
        const td = todayISO();
        const obj = safeJSON(localStorage.getItem(remindedKey), null);
        if (!obj || obj.date !== td) return { date: td, map: {} };
        return obj;
      };
      const setReminded = (activityId) => {
        const obj = getRemindedMap();
        obj.map[String(activityId)] = true;
        localStorage.setItem(remindedKey, JSON.stringify(obj));
      };
      const alreadyReminded = (activityId) => {
        const obj = getRemindedMap();
        return !!obj.map[String(activityId)];
      };

      const fireReminder = (a) => {
        const cat = categoryConfig[a.category] || categoryConfig.OUTROS;
        const pri = priorityConfig[a.priority] || priorityConfig.med;
        const catName = a.category === "ALIMENTACAO" ? "ALIMENTA√á√ÉO" : a.category;

        unlockAudio();
        playPop();

        showToast(
          `‚è∞ ${a.title}`,
          `${cat.emoji} ${catName} ‚Ä¢ ${pri.emoji} ${pri.label} ‚Ä¢ ${a.startTime} ‚Üí ${a.endTime}`
        );

        if (notifEnabled && ("Notification" in window) && Notification.permission === "granted"){
          try{
            new Notification(`‚è∞ ${a.title}`, {
              body: `${cat.emoji} ${catName} ‚Ä¢ ${pri.label} ‚Ä¢ ${a.startTime} ‚Üí ${a.endTime}`,
              silent: false
            });
          }catch{}
        }
      };

      const clearTimers = () => {
        timersRef.current.forEach(t => clearTimeout(t));
        timersRef.current = [];
        if (heartbeatRef.current) clearInterval(heartbeatRef.current);
        heartbeatRef.current = null;
      };

      const scheduleReminders = () => {
        clearTimers();
        const td = todayISO();
        const listToday = activitiesByDate[td] || [];
        if (!Array.isArray(listToday) || listToday.length === 0) return;

        const now = new Date();

        listToday.forEach(a => {
          if (!a.remind || a.completed) return;
          if (alreadyReminded(a.id)) return;

          const mins = parseTimeToMinutes(a.startTime);
          if (mins === null) return;

          const target = new Date();
          target.setHours(Math.floor(mins/60), mins%60, 0, 0);

          const delay = target.getTime() - now.getTime();
          if (delay <= 0) return;

          const t = setTimeout(() => {
            const latestToday = (activitiesByDate[todayISO()] || []);
            const found = latestToday.find(x => x.id === a.id);
            if (!found || found.completed) return;
            if (!alreadyReminded(a.id)){
              fireReminder(found);
              setReminded(a.id);
            }
          }, delay);

          timersRef.current.push(t);
        });

        heartbeatRef.current = setInterval(() => {
          const cur = new Date();
          const curMins = cur.getHours()*60 + cur.getMinutes();
          const latestToday = (activitiesByDate[todayISO()] || []);
          latestToday.forEach(a => {
            if (!a.remind || a.completed) return;
            if (alreadyReminded(a.id)) return;

            const tMins = parseTimeToMinutes(a.startTime);
            if (tMins === null) return;

            if (curMins >= tMins && curMins <= (tMins + 15)){
              fireReminder(a);
              setReminded(a.id);
            }
          });
        }, 30000);
      };

      useEffect(() => {
        scheduleReminders();
        return clearTimers;
      }, [activitiesByDate, notifEnabled, soundEnabled]);

      // ===== Planner (week chips + date + month) =====
      const setDayInSameWeek = (dayIndex) => {
        // pega SEG da semana do selectedDate
        const dt = new Date(selectedDate + "T00:00:00");
        const js = dt.getDay(); // 0 dom
        const mondayOffset = (js === 0) ? -6 : (1 - js);
        dt.setDate(dt.getDate() + mondayOffset);

        let offset = 0;
        if (dayIndex === 0) offset = 6; // domingo
        else offset = dayIndex - 1;

        dt.setDate(dt.getDate() + offset);
        const iso = dt.toISOString().split("T")[0];
        setSelectedDate(iso);
        setMonthView(monthKeyOfISO(iso));
      };

      // ===== Reset modal actions =====
      const [resetDate, setResetDate] = useState(todayISO());
      const [resetActivityId, setResetActivityId] = useState("");
      const [resetRangeMonth, setResetRangeMonth] = useState(getCurrentMonthKey());
      const [resetRangeMode, setResetRangeMode] = useState("mes"); // mes | fase | custom
      const [resetPhase, setResetPhase] = useState(weekPhaseOfMonth(todayISO()));
      const [resetFrom, setResetFrom] = useState(todayISO());
      const [resetTo, setResetTo] = useState(todayISO());

      const resetDayList = useMemo(() => activitiesByDate[resetDate] || [], [activitiesByDate, resetDate]);

      const doUncompleteActivity = () => {
        const id = String(resetActivityId || "");
        if (!id) { alert("Selecione uma atividade."); return; }
        setActivitiesByDate(prev => {
          const copy = { ...prev };
          const arr = Array.isArray(copy[resetDate]) ? [...copy[resetDate]] : [];
          copy[resetDate] = arr.map(a => a.id == id ? { ...a, completed:false } : a);
          return copy;
        });
        showToast("‚ôªÔ∏è Reset", "Atividade marcada como n√£o conclu√≠da.");
      };

      const doDeleteActivity = () => {
        const id = String(resetActivityId || "");
        if (!id) { alert("Selecione uma atividade."); return; }
        if (!confirm("Apagar essa atividade? (irrevers√≠vel)")) return;
        removeActivity(resetDate, Number(id));
        showToast("üóëÔ∏è Apagado", "Atividade removida.");
      };

      const doResetDay = () => {
        if ((activitiesByDate[resetDate] || []).length === 0){ alert("Esse dia n√£o tem atividades."); return; }
        setActivitiesByDate(prev => {
          const copy = { ...prev };
          const arr = Array.isArray(copy[resetDate]) ? [...copy[resetDate]] : [];
          copy[resetDate] = arr.map(a => ({ ...a, completed:false }));
          return copy;
        });
        showToast("‚ôªÔ∏è Reset", `Dia ${formatDateBR(resetDate)} resetado.`);
      };

      const doClearDay = () => {
        if ((activitiesByDate[resetDate] || []).length === 0){ alert("Esse dia n√£o tem atividades."); return; }
        if (!confirm(`Apagar TODAS as atividades de ${formatDateBR(resetDate)}?`)) return;
        setActivitiesByDate(prev => {
          const copy = { ...prev };
          delete copy[resetDate];
          return copy;
        });
        showToast("üóëÔ∏è Limpo", `Dia ${formatDateBR(resetDate)} apagado.`);
      };

      const rangeTargets = useMemo(() => {
        if (resetRangeMode === "mes"){
          const mk = resetRangeMonth;
          const [y,m] = mk.split("-").map(x => clampInt(x,0));
          const dim = daysInMonth(y,m);
          return { startISO: `${mk}-01`, endISO: `${mk}-${pad2(dim)}` };
        }
        if (resetRangeMode === "fase"){
          return phaseRange(resetRangeMonth, clampInt(resetPhase, 1));
        }
        // custom
        const a = resetFrom <= resetTo ? resetFrom : resetTo;
        const b = resetFrom <= resetTo ? resetTo : resetFrom;
        return { startISO: a, endISO: b };
      }, [resetRangeMode, resetRangeMonth, resetPhase, resetFrom, resetTo]);

      const doResetRange = () => {
        const { startISO, endISO } = rangeTargets;
        let any = false;
        setActivitiesByDate(prev => {
          const copy = { ...prev };
          Object.keys(copy).forEach(d => {
            if (d < startISO || d > endISO) return;
            const arr = Array.isArray(copy[d]) ? copy[d] : [];
            if (arr.length === 0) return;
            any = true;
            copy[d] = arr.map(a => ({ ...a, completed:false }));
          });
          return copy;
        });
        if (!any){ alert("Nenhuma atividade encontrada no intervalo."); return; }
        showToast("‚ôªÔ∏è Reset", `Intervalo resetado: ${formatDateBR(startISO)} ‚Üí ${formatDateBR(endISO)}`);
      };

      const doClearRange = () => {
        const { startISO, endISO } = rangeTargets;
        if (!confirm(`Apagar TODAS as atividades de ${formatDateBR(startISO)} at√© ${formatDateBR(endISO)}?`)) return;
        let any = false;
        setActivitiesByDate(prev => {
          const copy = { ...prev };
          Object.keys(copy).forEach(d => {
            if (d < startISO || d > endISO) return;
            any = true;
            delete copy[d];
          });
          return copy;
        });
        if (!any){ alert("Nenhuma atividade encontrada no intervalo."); return; }
        showToast("üóëÔ∏è Limpo", `Intervalo apagado: ${formatDateBR(startISO)} ‚Üí ${formatDateBR(endISO)}`);
      };

      // ===== UI Components =====
      function ActivityForm({ initial, onSave, onCancel }){
        const init = initial || {
          title:"",
          startTime:"09:00",
          endTime:"10:00",
          category:"TRABALHO",
          description:"",
          priority:"med",
          remind:true,
        };
        const [form, setForm] = useState(init);
        const pri = priorityConfig[form.priority] || priorityConfig.med;
        const catKeys = Object.keys(categoryConfig);

        const validate = () => {
          const st = parseTimeToMinutes(form.startTime);
          const et = parseTimeToMinutes(form.endTime);
          if (st === null || et === null) return "Preencha DE e AT√â.";
          if (et <= st) return "AT√â precisa ser maior que DE.";
          return null;
        };

        return e("div", null,
          e("div", { style:{ display:"flex", gap:12, flexWrap:"wrap" } },
            e("div", { style:{ flex:"1 1 380px" } },
              e("div", { className:"label" }, "üìù T√≠tulo"),
              e("input", {
                className:"input",
                name:"title",
                id:"title",
                value: form.title,
                placeholder:"Ex: Medita√ß√£o matinal",
                onChange:(ev)=>setForm({ ...form, title: ev.target.value })
              })
            ),

            e("div", { style:{ flex:"1 1 420px" } },
              e("div", { className:"label" }, "‚è∞ Hor√°rio"),
              e("div", { className:"grid2" },
                e("div", null,
                  e("div", { className:"label", style:{ marginBottom:6 } }, "DE"),
                  e("input", {
                    className:"input",
                    type:"time",
                    name:"startTime",
                    id:"startTime",
                    value: form.startTime,
                    onChange:(ev)=>setForm({ ...form, startTime: ev.target.value })
                  })
                ),
                e("div", null,
                  e("div", { className:"label", style:{ marginBottom:6 } }, "AT√â"),
                  e("input", {
                    className:"input",
                    type:"time",
                    name:"endTime",
                    id:"endTime",
                    value: form.endTime,
                    onChange:(ev)=>setForm({ ...form, endTime: ev.target.value })
                  })
                )
              ),
              e("div", { className:"sp10" }),
              e("span", { className:"pill" }, `DE ${form.startTime || "--:--"} ‚Üí AT√â ${form.endTime || "--:--"}`)
            )
          ),

          e("div", { className:"sp16" }),

          e("div", { className:"label" }, "üè∑Ô∏è Categoria"),
          e("div", { className:"grid3" },
            catKeys.map(k => {
              const on = form.category === k;
              const tint = on ? pri.tint : "";
              const c = categoryConfig[k];
              const label = (k === "ALIMENTACAO") ? "ALIMENTA√á√ÉO" : k;
              return e("div", {
                key:k,
                className: "chip" + (on ? (" chipOn " + tint) : ""),
                onClick: ()=> setForm({ ...form, category:k }),
                "data-tip": "Define a categoria da atividade. A borda acompanha a prioridade selecionada."
              }, c.emoji, " ", label);
            })
          ),

          e("div", { className:"sp16" }),

          e("div", { className:"label" }, "‚≠ê Prioridade"),
          e("div", { className:"grid3" },
            Object.entries(priorityConfig).map(([key, p]) => {
              const on = form.priority === key;
              return e("div", {
                key,
                className:"chip" + (on ? (" chipOn " + p.tint) : ""),
                onClick: ()=> setForm({ ...form, priority:key }),
                "data-tip": "Baixa, M√©dia ou Alta. A prioridade muda cores e o peso do progresso mensal."
              }, p.emoji, " ", p.label);
            })
          ),

          e("div", { className:"sp16" }),

          e("div", { className:"label" }, "üîî Lembrete"),
          e("div", {
            className:"chip" + (form.remind ? " chipOn" : ""),
            style:{ justifyContent:"space-between" },
            onClick: ()=> setForm({ ...form, remind: !form.remind }),
            "data-tip": "Se ativado, o app dispara lembrete no hor√°rio DE (som + toast + notifica√ß√£o do sistema se permitido)."
          },
            e("div", { style:{ display:"flex", gap:10, alignItems:"center" } },
              form.remind ? "‚è∞" : "üîï",
              form.remind ? "Ativado" : "Desativado"
            ),
            e("span", { className:"muted", style:{ fontSize:12, fontWeight:950 } }, "no hor√°rio DE")
          ),

          e("div", { className:"sp16" }),

          e("div", { className:"label" }, "üìÑ Descri√ß√£o"),
          e("textarea", {
            className:"input",
            name:"description",
            id:"description",
            rows:3,
            value: form.description,
            placeholder:"Detalhes opcionais...",
            onChange:(ev)=>setForm({ ...form, description: ev.target.value })
          }),

          e("div", { className:"sp16" }),

          e("div", { style:{ display:"flex", gap:12, flexWrap:"wrap" } },
            e("button", {
              className:"btn btnPrimary",
              style:{ flex:"1 1 260px" },
              "data-tip":"Salva a atividade no dia selecionado.",
              onClick: ()=>{
                const err = validate();
                if (!form.title.trim()) { alert("Informe um t√≠tulo."); return; }
                if (err) { alert(err); return; }

                onSave({
                  title: form.title.trim(),
                  startTime: form.startTime,
                  endTime: form.endTime,
                  category: form.category,
                  description: form.description || "",
                  priority: form.priority,
                  remind: !!form.remind,
                });
              }
            }, "üíæ Salvar"),
            e("button", {
              className:"btn btnSoft",
              style:{ flex:"1 1 160px" },
              "data-tip":"Cancela e fecha a janela.",
              onClick: onCancel
            }, "Cancelar")
          )
        );
      }

      function ActivityCard({ a }){
        const cat = categoryConfig[a.category] || categoryConfig.OUTROS;
        const pri = priorityConfig[a.priority] || priorityConfig.med;
        const catName = a.category === "ALIMENTACAO" ? "ALIMENTA√á√ÉO" : a.category;

        const cls = ["act", pri.card, a.completed ? "done" : ""].join(" ").trim();

        return e("div", { className: cls },
          e("div", { className:"actTop" },
            e("div", { className:"actLeft" },
              e("input", {
                className:"check",
                type:"checkbox",
                checked: !!a.completed,
                onChange:()=>toggleDone(a.date, a.id),
                "data-tip":"Marca/desmarca como conclu√≠da. Isso afeta seu progresso do jogo."
              }),
              e("div", null,
                e("div", { className:"actTitle" }, `${cat.emoji} ${a.title}`),
                e("div", { className:"actMeta" },
                  e("span", { className:"tag" }, `‚è∞ ${a.startTime} ‚Üí ${a.endTime}`),
                  e("span", { className:"tag" }, `${pri.emoji} ${pri.label}`),
                  e("span", { className:"tag" }, `üè∑Ô∏è ${catName}`),
                  e("span", { className:"tag" }, a.remind ? "üîî Lembrete" : "üîï Sem lembrete")
                ),
                a.description ? e("div", { className:"actDesc" }, `üìù ${a.description}`) : null
              )
            ),
            e("div", { className:"actBtns" },
              e("button", { className:"miniBtn", onClick:()=>openEdit(a), "data-tip":"Editar t√≠tulo, hor√°rio, prioridade, categoria, lembrete etc." }, "‚úèÔ∏è Editar"),
              e("button", { className:"miniBtn miniDanger", onClick:()=>deleteActivity(a.date, a.id), "data-tip":"Apaga a atividade permanentemente." }, "üóëÔ∏è Deletar")
            )
          )
        );
      }

      // ===== UI: Planner labels =====
      const selectedLabel = `${weekday(selectedDate)} ‚Ä¢ ${formatDateBR(selectedDate)}`;
      const isTodaySelected = selectedDate === todayISO();

      // ===== Simple ‚Äúbars‚Äù colors =====
      const barColor = (pct) => {
        if (pct >= 85) return "linear-gradient(90deg, rgba(34,197,94,.95), rgba(16,185,129,.95))";
        if (pct >= 70) return "linear-gradient(90deg, rgba(245,158,11,.95), rgba(234,179,8,.95))";
        return "linear-gradient(90deg, rgba(239,68,68,.95), rgba(249,115,22,.95))";
      };

      // ===== Reset Modal =====
      function ResetModal(){
        return e(Modal, {
          open: resetOpen,
          onClose: ()=> setResetOpen(false),
          title: "üßπ RESET (personalizado)"
        },
          e("div", { className:"tabs" },
            e("button", { className:"tabBtn " + (resetTab==="atividade"?"tabOn":""), onClick:()=>setResetTab("atividade"),
              "data-tip":"Reset de uma atividade espec√≠fica (qualquer dia)."
            }, "Atividade"),
            e("button", { className:"tabBtn " + (resetTab==="dia"?"tabOn":""), onClick:()=>setResetTab("dia"),
              "data-tip":"Reset ou apagar todas as atividades de um dia espec√≠fico."
            }, "Dia"),
            e("button", { className:"tabBtn " + (resetTab==="intervalo"?"tabOn":""), onClick:()=>setResetTab("intervalo"),
              "data-tip":"Reset ou apagar um per√≠odo: m√™s, fase (semana do m√™s) ou intervalo custom."
            }, "Intervalo")
          ),

          e("div", { className:"sp16" }),

          resetTab === "atividade" && e("div", null,
            e("div", { className:"label" }, "üìÖ Escolha o dia"),
            e("input", {
              className:"input",
              type:"date",
              value: resetDate,
              onChange:(ev)=>{ setResetDate(ev.target.value || todayISO()); setResetActivityId(""); }
            }),

            e("div", { className:"sp10" }),

            e("div", { className:"label" }, "üéØ Escolha a atividade"),
            e("select", {
              className:"input",
              value: resetActivityId,
              onChange:(ev)=>setResetActivityId(ev.target.value),
              "data-tip":"Lista as atividades do dia escolhido."
            },
              e("option", { value:"" }, resetDayList.length ? "Selecione..." : "Nenhuma atividade nesse dia"),
              resetDayList.map(a => e("option", { key:a.id, value:String(a.id) }, `${a.startTime}‚Üí${a.endTime} ‚Ä¢ ${a.title}`))
            ),

            e("div", { className:"sp16" }),

            e("div", { style:{ display:"flex", gap:12, flexWrap:"wrap" } },
              e("button", {
                className:"btn btnPrimary",
                onClick: doUncompleteActivity,
                "data-tip":"Desmarca como conclu√≠da (n√£o apaga)."
              }, "‚ôªÔ∏è Resetar conclus√£o"),
              e("button", {
                className:"btn btnSoft",
                onClick: doDeleteActivity,
                "data-tip":"Apaga essa atividade permanentemente (com confirma√ß√£o)."
              }, "üóëÔ∏è Apagar atividade")
            )
          ),

          resetTab === "dia" && e("div", null,
            e("div", { className:"label" }, "üìÖ Escolha o dia"),
            e("input", {
              className:"input",
              type:"date",
              value: resetDate,
              onChange:(ev)=>{ setResetDate(ev.target.value || todayISO()); setResetActivityId(""); }
            }),
            e("div", { className:"sp10" }),
            e("div", { className:"pill" }, `Atividades: ${(activitiesByDate[resetDate]||[]).length}`),

            e("div", { className:"sp16" }),
            e("div", { style:{ display:"flex", gap:12, flexWrap:"wrap" } },
              e("button", {
                className:"btn btnPrimary",
                onClick: doResetDay,
                "data-tip":"Desmarca todas como n√£o conclu√≠das nesse dia."
              }, "‚ôªÔ∏è Resetar dia"),
              e("button", {
                className:"btn btnSoft",
                onClick: doClearDay,
                "data-tip":"Apaga todas as atividades desse dia (com confirma√ß√£o)."
              }, "üóëÔ∏è Limpar dia")
            )
          ),

          resetTab === "intervalo" && e("div", null,
            e("div", { className:"label" }, "üß≠ Tipo de intervalo"),
            e("div", { className:"grid3" },
              e("div", { className:"chip " + (resetRangeMode==="mes"?"chipOn":""),
                onClick:()=>setResetRangeMode("mes"),
                "data-tip":"Seleciona um m√™s inteiro."
              }, "üóìÔ∏è M√™s"),
              e("div", { className:"chip " + (resetRangeMode==="fase"?"chipOn":""),
                onClick:()=>setResetRangeMode("fase"),
                "data-tip":"Seleciona uma fase (semana do m√™s: 1‚Äì5)."
              }, "üéÆ Fase"),
              e("div", { className:"chip " + (resetRangeMode==="custom"?"chipOn":""),
                onClick:()=>setResetRangeMode("custom"),
                "data-tip":"Seleciona um intervalo DE/AT√â custom."
              }, "üìå Custom")
            ),

            e("div", { className:"sp16" }),

            e("div", { className:"label" }, "üìÖ Configurar intervalo"),
            e("div", { className:"grid2" },
              e("div", null,
                e("div", { className:"label", style:{ marginBottom:6 } }, "M√™s (YYYY-MM)"),
                e("input", {
                  className:"input",
                  value: resetRangeMonth,
                  onChange:(ev)=>setResetRangeMonth(ev.target.value || getCurrentMonthKey()),
                  placeholder:"2026-02",
                  "data-tip":"Digite no formato YYYY-MM. Ex: 2026-02"
                })
              ),
              e("div", null,
                resetRangeMode==="fase"
                  ? e("div", null,
                      e("div", { className:"label", style:{ marginBottom:6 } }, "Fase do m√™s (1‚Äì5)"),
                      e("input", {
                        className:"input",
                        type:"number",
                        min:"1", max:"5",
                        value: resetPhase,
                        onChange:(ev)=>setResetPhase(clampInt(ev.target.value, 1)),
                        "data-tip":"Fase 1: 1‚Äì7, Fase 2: 8‚Äì14, Fase 3: 15‚Äì21, Fase 4: 22‚Äì28, Fase 5: 29‚Äìfim."
                      })
                    )
                  : resetRangeMode==="custom"
                    ? e("div", null,
                        e("div", { className:"label", style:{ marginBottom:6 } }, "DE / AT√â"),
                        e("div", { className:"grid2" },
                          e("input", { className:"input", type:"date", value: resetFrom, onChange:(ev)=>setResetFrom(ev.target.value || todayISO()) }),
                          e("input", { className:"input", type:"date", value: resetTo, onChange:(ev)=>setResetTo(ev.target.value || todayISO()) })
                        )
                      )
                    : e("div", null,
                        e("div", { className:"label", style:{ marginBottom:6 } }, " "),
                        e("span", { className:"pill" }, "M√™s inteiro selecionado")
                      )
              )
            ),

            e("div", { className:"sp10" }),
            e("span", { className:"pill" }, `Intervalo: ${formatDateBR(rangeTargets.startISO)} ‚Üí ${formatDateBR(rangeTargets.endISO)}`),

            e("div", { className:"sp16" }),
            e("div", { style:{ display:"flex", gap:12, flexWrap:"wrap" } },
              e("button", {
                className:"btn btnPrimary",
                onClick: doResetRange,
                "data-tip":"Desmarca como n√£o conclu√≠das todas as atividades do intervalo."
              }, "‚ôªÔ∏è Resetar intervalo"),
              e("button", {
                className:"btn btnSoft",
                onClick: doClearRange,
                "data-tip":"Apaga permanentemente todas as atividades do intervalo (com confirma√ß√£o)."
              }, "üóëÔ∏è Limpar intervalo")
            )
          )
        );
      }

      return e("div", { className:"app" },
        e("div", { className:"container" },

          e("div", { className:"top" },
            e("div", null, e("div", { className:"title" }, "üéØ Rotina ‚Ä¢ Foco & Prosperidade")),
            e("div", { style:{ display:"flex", gap:12, flexWrap:"wrap" } },
              e("button", { className:"btn btnSoft", onClick: exportRoutine, "data-tip":"Gera um JSON com seus dados para backup." }, "üì¶ Exportar"),
              e("button", { className:"btn btnSoft", onClick: ()=>setExportOpen(true), "data-tip":"Cole um JSON exportado para restaurar seus dados." }, "üì• Importar"),
              e("button", { className:"btn btnPrimary", onClick: openNew, "data-tip":"Cria uma atividade para o dia selecionado." }, "‚ûï Nova Atividade")
            )
          ),

          e("div", { className:"sp16" }),

          e("div", { className:"row" },
            e("div", { className:"col glass", style:{ padding:16 } },
              e("div", { style:{ display:"flex", alignItems:"center", justifyContent:"space-between", gap:10, flexWrap:"wrap" } },
                e("div", null,
                  e("div", { className:"kicker" }, "FASE DO M√äS (JOGO)"),
                  e("div", { className:"big" }, `${curPhaseStats.pct}%`)
                ),
                e("span", { className:"pill" }, `üéÆ Fase ${currentPhase}/5 ‚Ä¢ Meta ${PHASE_GOAL}%`)
              ),
              e("div", { className:"barWrap" }, e("div", { className:"barFill", style:{ width: curPhaseStats.pct + "%", background: barColor(curPhaseStats.pct) } })),
              e("div", { className:"sp10" }),
              e("div", { className:"muted", style:{ fontWeight:950 } }, `${curPhaseStats.completed}/${curPhaseStats.total} conclu√≠das`)
            ),

            e("div", { className:"col glass", style:{ padding:16 } },
              e("div", { className:"kicker" }, "PROGRESSO DO M√äS"),
              e("div", { className:"big" }, `${curMonthStats.pct}%`),
              e("div", { className:"sp10" }),
              e("span", { className:"pill" }, `üíé N√≠vel ${monthState.levelUnlocked}/5`),
              e("div", { className:"sp10" }),
              e("div", { className:"muted", style:{ fontWeight:950 } }, `Score: ${curMonthStats.done}/${curMonthStats.possible}`)
            ),

            e("div", { className:"col glass", style:{ padding:16 } },
              e("div", { className:"kicker" }, "CONTROLES"),
              e("div", { className:"sp10" }),
              e("div", { style:{ display:"flex", gap:12, flexWrap:"wrap" } },

                e("button", {
                  className:"btn btnSoft",
                  onClick: ()=> setResetOpen(true),
                  "data-tip":"Resetar uma tarefa espec√≠fica, um dia, uma fase do m√™s ou um m√™s inteiro (de forma individual)."
                }, "üßπ RESET"),

                e("button", {
                  className:"btn " + (notifEnabled ? "btnPrimary" : "btnSoft"),
                  onClick: requestNotificationPermission,
                  "data-tip":"Ativa notifica√ß√µes do sistema para os lembretes."
                }, notifEnabled ? "üîî Notif: ON" : "üîî Ativar notif"),

                e("button", {
                  className:"btn " + (soundEnabled ? "btnPrimary" : "btnSoft"),
                  onClick: ()=>{ unlockAudio(); setSoundEnabled(!soundEnabled); },
                  "data-tip":"Toca um som POP quando um lembrete dispara."
                }, soundEnabled ? "üîä Som: ON" : "üîá Som: OFF"),

                e("button", { className:"btn btnSoft", onClick: testSound, "data-tip":"Toca um POP para testar o √°udio." }, "üéß Testar som")
              ),

              e("div", { className:"sp10" }),
              e("div", { className:"muted", style:{ fontWeight:950 } },
                "Reset mensal autom√°tico: no 1¬∫ dia do m√™s (ou ao virar o m√™s), o n√≠vel volta ao in√≠cio."
              )
            )
          ),

          e("div", { className:"sp16" }),

          // ===== Planner =====
          e("div", { className:"glass", style:{ padding:14 } },
            e("div", { className:"kicker" }, "PLANEJAMENTO"),
            e("div", { className:"sp10" }),

            e("div", { style:{ display:"flex", gap:12, flexWrap:"wrap", alignItems:"center", justifyContent:"space-between" } },
              e("div", { style:{ display:"flex", gap:10, flexWrap:"wrap", alignItems:"center" } },
                e("span", { className:"pill" }, `üìÖ ${selectedLabel}`),
                e("span", { className:"pill" }, isTodaySelected ? "‚úÖ HOJE" : "üóìÔ∏è OUTRO DIA")
              ),
              e("div", { style:{ display:"flex", gap:10, flexWrap:"wrap" } },
                e("button", { className:"btn " + (plannerMode==="day" ? "btnPrimary" : "btnSoft"), onClick:()=>setPlannerMode("day"), "data-tip":"Planejar por dia (data espec√≠fica + dias da semana)." }, "Dia"),
                e("button", { className:"btn " + (plannerMode==="month" ? "btnPrimary" : "btnSoft"), onClick:()=>setPlannerMode("month"), "data-tip":"Abrir calend√°rio do m√™s para escolher um dia." }, "M√™s")
              )
            ),

            plannerMode === "day"
              ? e("div", null,
                  e("div", { className:"sp10" }),
                  e("div", { style:{ display:"flex", gap:12, flexWrap:"wrap", alignItems:"center", justifyContent:"space-between" } },
                    e("div", { style:{ display:"flex", gap:10, flexWrap:"wrap" } },
                      e("button", { className:"btn btnSoft", onClick:()=>{ const d=addDaysISO(selectedDate,-1); setSelectedDate(d); setMonthView(monthKeyOfISO(d)); }, "data-tip":"Ir para o dia anterior." }, "‚óÄ"),
                      e("button", { className:"btn btnSoft", onClick:()=>{ const d=todayISO(); setSelectedDate(d); setMonthView(monthKeyOfISO(d)); }, "data-tip":"Voltar para hoje." }, "Hoje"),
                      e("button", { className:"btn btnSoft", onClick:()=>{ const d=addDaysISO(selectedDate,+1); setSelectedDate(d); setMonthView(monthKeyOfISO(d)); }, "data-tip":"Ir para o pr√≥ximo dia." }, "‚ñ∂")
                    ),
                    e("div", { style:{ display:"flex", gap:10, flexWrap:"wrap" } },
                      e("input", {
                        className:"input",
                        type:"date",
                        value: selectedDate,
                        onChange:(ev)=>{ const v=ev.target.value || todayISO(); setSelectedDate(v); setMonthView(monthKeyOfISO(v)); },
                        "data-tip":"Escolha uma data espec√≠fica para criar/ver atividades."
                      })
                    )
                  ),

                  e("div", { className:"sp10" }),
                  e("div", { className:"grid3" },
                    e("div", { className:"chip " + (weekday(selectedDate)==="SEG" ? "chipOn" : ""), onClick:()=>setDayInSameWeek(1), "data-tip":"Selecionar Segunda (na semana da data atual)." }, "SEG"),
                    e("div", { className:"chip " + (weekday(selectedDate)==="TER" ? "chipOn" : ""), onClick:()=>setDayInSameWeek(2), "data-tip":"Selecionar Ter√ßa (na semana da data atual)." }, "TER"),
                    e("div", { className:"chip " + (weekday(selectedDate)==="QUA" ? "chipOn" : ""), onClick:()=>setDayInSameWeek(3), "data-tip":"Selecionar Quarta (na semana da data atual)." }, "QUA"),
                    e("div", { className:"chip " + (weekday(selectedDate)==="QUI" ? "chipOn" : ""), onClick:()=>setDayInSameWeek(4), "data-tip":"Selecionar Quinta (na semana da data atual)." }, "QUI"),
                    e("div", { className:"chip " + (weekday(selectedDate)==="SEX" ? "chipOn" : ""), onClick:()=>setDayInSameWeek(5), "data-tip":"Selecionar Sexta (na semana da data atual)." }, "SEX"),
                    e("div", { className:"chip " + (weekday(selectedDate)==="S√ÅB" ? "chipOn" : ""), onClick:()=>setDayInSameWeek(6), "data-tip":"Selecionar S√°bado (na semana da data atual)." }, "S√ÅB"),
                    e("div", { className:"chip " + (weekday(selectedDate)==="DOM" ? "chipOn" : ""), onClick:()=>setDayInSameWeek(0), "data-tip":"Selecionar Domingo (na semana da data atual)." }, "DOM")
                  )
                )
              : e("div", { className:"calWrap" },
                  e("div", { className:"calHeader" },
                    e("div", { style:{ display:"flex", gap:10, flexWrap:"wrap", alignItems:"center" } },
                      e("span", { className:"pill" }, `üóìÔ∏è ${monthLabelBR(monthView)}`),
                      e("span", { className:"pill" }, "Clique em um dia para abrir")
                    ),
                    e("div", { style:{ display:"flex", gap:10, flexWrap:"wrap" } },
                      e("button", { className:"btn btnSoft", onClick:()=>goMonth(-1), "data-tip":"Ver m√™s anterior." }, "‚óÄ M√™s"),
                      e("button", { className:"btn btnSoft", onClick:()=>{ const d=todayISO(); setSelectedDate(d); setMonthView(monthKeyOfISO(d)); }, "data-tip":"Voltar para hoje." }, "Hoje"),
                      e("button", { className:"btn btnSoft", onClick:()=>goMonth(+1), "data-tip":"Ver pr√≥ximo m√™s." }, "M√™s ‚ñ∂")
                    )
                  ),

                  e("div", { className:"calGrid" },
                    ["SEG","TER","QUA","QUI","SEX","S√ÅB","DOM"].map(d => e("div", { key:d, className:"calDow" }, d)),

                    monthCells.map(cell => {
                      const iso = cell.iso;
                      const sum = daySummary(iso);
                      const isSelected = iso === selectedDate;
                      const isToday = iso === todayISO();

                      const dots = [];
                      if (sum.p.low) dots.push(e("span", { key:"l", className:"dot", style:{ background:"rgba(34,197,94,.95)" } }));
                      if (sum.p.med) dots.push(e("span", { key:"m", className:"dot", style:{ background:"rgba(245,158,11,.95)" } }));
                      if (sum.p.high) dots.push(e("span", { key:"h", className:"dot", style:{ background:"rgba(239,68,68,.95)" } }));

                      const cls = [
                        "calCell",
                        cell.inMonth ? "" : "calMuted",
                        isSelected ? "calSelected" : "",
                        isToday ? "calToday" : ""
                      ].join(" ").trim();

                      const dayNum = clampInt(iso.slice(8,10), 0);

                      return e("div", {
                        key: iso,
                        className: cls,
                        onClick: ()=> {
                          if (!cell.inMonth) return;
                          setSelectedDate(iso);
                          setPlannerMode("day");
                        },
                        title: formatDateBR(iso),
                        "data-tip": "Clique para abrir esse dia. O resumo mostra conclu√≠das/total e prioridades."
                      },
                        e("div", { className:"calDayNum" }, dayNum),
                        sum.total > 0
                          ? e("div", { className:"calMini" },
                              e("span", null, `${sum.completed}/${sum.total}`),
                              e("div", { className:"calDots" }, dots)
                            )
                          : e("div", { className:"calMini", style:{ opacity:.75 } }, e("span", null, "‚Äî"), e("span", null, ""))
                      );
                    })
                  )
                ),

            e("div", { className:"sp10" }),
            e("div", { className:"muted", style:{ fontWeight:950 } },
              "Voc√™ cria e v√™ atividades do dia selecionado. Lembretes s√≥ disparam para o dia de hoje."
            )
          ),

          e("div", { className:"sp16" }),

          // ===== Activities list =====
          e("div", { className:"card" },
            e("div", { className:"listHead" },
              e("div", { style:{ display:"flex", alignItems:"center", gap:10, flexWrap:"wrap" } },
                e("div", { style:{ fontSize:18, fontWeight:950 } }, "üìã Atividades"),
                e("span", { className:"pill" }, `üìÖ ${selectedLabel}`),
                e("span", { className:"pill" }, "‚è±Ô∏è ordenadas por in√≠cio")
              ),
              e("div", { className:"muted", style:{ fontWeight:950 } },
                sorted.length === 0 ? "Sem atividades" : "Marque para concluir ‚úÖ"
              )
            ),
            e("div", { className:"listBody" },
              sorted.length === 0
                ? e("div", { className:"glass", style:{ padding:18, textAlign:"center" } },
                    e("div", { style:{ fontSize:34 } }, "üß†"),
                    e("div", { style:{ fontSize:18, fontWeight:950, marginTop:6 } }, "Nenhuma atividade ainda"),
                    e("div", { className:"muted", style:{ marginTop:6, fontWeight:950 } }, "Clique em ‚ÄúNova Atividade‚Äù para come√ßar.")
                  )
                : sorted.map(a => e(ActivityCard, { key:a.id, a }))
            )
          ),

          e(Modal, {
            open: modalOpen,
            onClose: ()=>{ setModalOpen(false); setEditing(null); },
            title: editing ? `‚úèÔ∏è Editar (${formatDateBR(editing.date || selectedDate)})` : `‚ûï Nova (${formatDateBR(selectedDate)})`
          }, e(ActivityForm, {
            initial: editing ? {
              title: editing.title,
              startTime: editing.startTime,
              endTime: editing.endTime,
              category: editing.category,
              description: editing.description,
              priority: editing.priority,
              remind: editing.remind,
            } : null,
            onSave: saveActivity,
            onCancel: ()=>{ setModalOpen(false); setEditing(null); }
          })),

          e(Modal, {
            open: exportOpen,
            onClose: ()=> setExportOpen(false),
            title: "üì¶ Exportar / Importar"
          },
            e("div", { className:"grid2" },
              e("div", null,
                e("div", { className:"label" }, "üì§ Exportar (JSON)"),
                e("textarea", {
                  className:"input",
                  rows:10,
                  value: exportData,
                  onChange:(ev)=>setExportData(ev.target.value),
                  placeholder:"Clique em Exportar para gerar..."
                }),
                e("div", { className:"sp10" }),
                e("div", { style:{ display:"flex", gap:12, flexWrap:"wrap" } },
                  e("button", { className:"btn btnSoft", style:{ flex:"1 1 160px" }, onClick: exportRoutine, "data-tip":"Gera um JSON atualizado." }, "Gerar"),
                  e("button", { className:"btn btnPrimary", style:{ flex:"1 1 160px" }, onClick: copyToClipboard, disabled: !exportData, "data-tip":"Copia o JSON para o clipboard." }, "üìã Copiar")
                )
              ),
              e("div", null,
                e("div", { className:"label" }, "üì• Importar (cole o JSON)"),
                e("textarea", {
                  className:"input",
                  rows:10,
                  value: importData,
                  onChange:(ev)=>setImportData(ev.target.value),
                  placeholder:"Cole aqui o JSON exportado..."
                }),
                e("div", { className:"sp10" }),
                e("div", { style:{ display:"flex", gap:12, flexWrap:"wrap" } },
                  e("button", { className:"btn btnPrimary", style:{ flex:"1 1 160px" }, onClick: importRoutine, disabled: !importData.trim(), "data-tip":"Importa e substitui os dados atuais." }, "Importar"),
                  e("button", { className:"btn btnSoft", style:{ flex:"1 1 160px" }, onClick: ()=>setImportData(""), "data-tip":"Limpa o campo." }, "Limpar")
                )
              )
            )
          ),

          e(ResetModal, null),

          e("div", { className:"toasts" },
            toasts.map(t => e("div", { key:t.id, className:"toast" },
              e("div", null,
                e("div", { className:"toastTitle" }, t.title),
                e("div", { className:"toastMsg" }, t.msg)
              ),
              e("button", { className:"toastX", onClick:()=>removeToast(t.id), "data-tip":"Fechar notifica√ß√£o." }, "‚úï")
            ))
          )
        )
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(React.createElement(DailyRoutine));
  </script>
</body>
</html>
